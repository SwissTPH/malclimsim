<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using malclimsim to infer parameters of a climate-driven dynamical transmission model • malclimsim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using malclimsim to infer parameters of a climate-driven dynamical transmission model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">malclimsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/using-malclimsim.html">Using malclimsim to infer parameters of a climate-driven dynamical transmission model</a></li>
    <li><a class="dropdown-item" href="../articles/using-your-own-model.html">How to import a model for use with malclimsim</a></li>
    <li><a class="dropdown-item" href="../articles/viewing-and-modifying-observation-functions.html">Viewing and modifying observation functions</a></li>
    <li><a class="dropdown-item" href="../articles/viewing-and-modifying-priors.html">Viewing and modifying priors</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nputney4/malclimsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using malclimsim to infer parameters of a climate-driven dynamical transmission model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nputney4/malclimsim/blob/HEAD/vignettes/using-malclimsim.Rmd" class="external-link"><code>vignettes/using-malclimsim.Rmd</code></a></small>
      <div class="d-none name"><code>using-malclimsim.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The climate-driven dynamical transmission model used in this package
is an adaptation from the one constructed by Ukawuba and Shaman in 2022
(<a href="https://doi.org/10.1371/journal.pcbi.1010161" class="external-link uri">https://doi.org/10.1371/journal.pcbi.1010161</a>). The
original paper calibrated the model using data at the provincial and
district levels (district-level analysis found in the supplement).</p>
<p>A few key characteristics of the model are that only humans are
modeled explicitly but climate-mosquito dynamics are incorporated
through the addition equations relating rainfall and temperature to the
entomological innoculation rate. It is a compartmental model with 10
total compartments across two age groups, splitting the population into
those who are Susceptible to disease, those who have been Exposed and
are infected by malaria parasites, those who have Symptomatic Infection
but untreated, those who have been Treated, and those who have
Asymptomatic infection.</p>
<p>Currently, the model assumes a year is 360 days with twelve 30 day
months when using monthly data and assumes 365 day years with 7 day
weeks when using weekly data. There are two age groups being modeled -
those under 5 years old and those who are 5 years and older. Only one
intervention is being considered here - seasonal malaria
chemoprevention.</p>
<p>This vignette will go through the process of defining the inputs for,
and simulating from, a predefined model of malaria transmission.
Afterwords, a number parameters of this model will be inferred using the
mcstate package. Lastly, diagnostics will be examined and relevant
quantities calculated.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#detach("package:malclimsim", unload = TRUE)</span></span>
<span><span class="co">#devtools::install_github("https://github.com/SwissTPH/malclimsim", ref = "development")</span></span>
<span><span class="co">#install.packages("odin.dust", repos = c("https://mrc-ide.r-universe.dev", "https://cloud.r-project.org"))</span></span>
<span><span class="co">#install.packages("mcstate", repos = c("https://mrc-ide.r-universe.dev", "https://cloud.r-project.org"))</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nputney4/malclimsim" class="external-link">malclimsim</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setting-up-model-inputs">Setting Up Model Inputs<a class="anchor" aria-label="anchor" href="#setting-up-model-inputs"></a>
</h2>
<div class="section level3">
<h3 id="climate-data-downloading-and-processing">Climate data downloading and processing<a class="anchor" aria-label="anchor" href="#climate-data-downloading-and-processing"></a>
</h3>
<p>The first step to using the model is to specify the region (latitude
and longitude) in which you want your model to simulate from.
Additionally, the years used in the analysis must be specified.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Years used for the analysis</span></span>
<span><span class="va">years_clim</span> <span class="op">&lt;-</span> <span class="fl">2017</span><span class="op">:</span><span class="fl">2023</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="st">"2018-01-01"</span><span class="op">)</span>  <span class="co"># Start date of the analysis</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">ymd</a></span><span class="op">(</span><span class="st">"2023-12-31"</span><span class="op">)</span>  <span class="co"># End date of the analysis</span></span>
<span><span class="va">years_analysis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">start_date</span><span class="op">)</span> <span class="op">:</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">end_date</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Latitude and longitude where climate data (rainfall and temperature) is to be saved</span></span>
<span><span class="co"># Rainfall data is from CHIRPS and temperature data is from ERA5</span></span>
<span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="fl">8.34</span></span>
<span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fl">17.77</span></span></code></pre></div>
<p>Next, “save_climate_data” will download the raw data from the
specified coordinates into the directory given by ‘path_to_data’, where
the data can be loaded from for future uses. The temperature data comes
from ‘ERA5-Land’ (<a href="https://cds.climate.copernicus.eu/datasets/derived-era5-land-daily-statistics?tab=overview" class="external-link uri">https://cds.climate.copernicus.eu/datasets/derived-era5-land-daily-statistics?tab=overview</a>)
and the rainfall data comes from ‘CHIRTSdaily’ (<a href="https://www.chc.ucsb.edu/data/chirtsdaily" class="external-link uri">https://www.chc.ucsb.edu/data/chirtsdaily</a>). To get
access to the CHIRPS data (and run the below function), one must
register with the European Centre for Medium-Range Weather Forecasts API
- instructions found here - <a href="https://bluegreen-labs.github.io/ecmwfr/" class="external-link uri">https://bluegreen-labs.github.io/ecmwfr/</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Saving the rainfall data locally based on specified path</span></span>
<span><span class="fu"><a href="../reference/save_climate_data.html">save_climate_data</a></span><span class="op">(</span>lon <span class="op">=</span> <span class="va">lon</span>, lat <span class="op">=</span> <span class="va">lat</span>, years <span class="op">=</span> <span class="va">years_clim</span>, </span>
<span>                  path_to_data <span class="op">=</span> <span class="va">path_to_data</span>,</span>
<span>                  rain_file_name <span class="op">=</span> <span class="va">rain_file_name</span>, temp_file_name <span class="op">=</span> <span class="va">temp_file_name</span><span class="op">)</span></span></code></pre></div>
<p>Now the data is processed using the ‘process_climate_data’ function.
A few things are done here. First, as the temperature data is in the
form of monthly averages and the model requires an input for each day,
smoothing splines are used to fit a smooth function to the data. This
function is then used to estimate daily temperatures. A few more things
are done with the rainfall data. First, the cumulative monthly rainfall
was calculated. Then, a smoothing spine was fit to this monthly data.
Afterwards, daily estimated were estimated from the fit. Lastly, the
daily estimates were standardized to have a mean of 0 and a variance of
1.</p>
<p>For more details, look at the code found in
“climate_processing_functions.R”.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reading in climate data saved by `save_climate_data`</span></span>
<span><span class="va">temp_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_to_data</span>, <span class="va">temp_file_name</span><span class="op">)</span></span>
<span><span class="va">rain_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">path_to_data</span>, <span class="va">rain_file_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Processing climate data to be used in the model</span></span>
<span><span class="co"># `months_30_days` determines if years are 360 or 365 days - if using weekly data, 365</span></span>
<span><span class="co"># days must be used and if using monthly data, 360 days must be used</span></span>
<span><span class="va">met_365</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_climate_data.html">process_climate_data</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, years <span class="op">=</span> <span class="va">years_clim</span>, temp_path <span class="op">=</span> <span class="va">temp_path</span>,</span>
<span>                            rain_path <span class="op">=</span> <span class="va">rain_path</span>, months_30_days <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="seasonal-malaria-chemoprevention-data-downloading-and-processing">Seasonal malaria chemoprevention data downloading and
processing<a class="anchor" aria-label="anchor" href="#seasonal-malaria-chemoprevention-data-downloading-and-processing"></a>
</h3>
<p>Next we will load the SMC data, which gives information about when
each round of SMC was given and the coverage for that round. As of now,
for the functions that process this SMC data, the format (column names)
must be as shown below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">smc_data_raw</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smc_data_raw</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">smc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_clean_smc_data.html">load_clean_smc_data</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">smc_data_raw</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smc_data</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>One now needs to define the inputs related to seasonal malaria
chemoprevention (SMC). There are three vectors that are needed which
should all the same length as the rainfall and temperature vectors. One
vector consists of 1s and 0s that define the start of a round of SMC.
The second vector is the coverage of SMC for that round. And the last
vector is the result of a decay function applied to the coverage over
time. The total effect of SMC at a given time point is defined as the
product (component-wise multiplication) of these vectors at this
time.</p>
<p>To go from the clean dataset, where we have rounds given in monthly
intervals, to daily intervals required by the model, we call the
`smc_schedule_from_data’ function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">smc_schedule</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smc_schedule_from_data.html">smc_schedule_from_data</a></span><span class="op">(</span></span>
<span>  smc_cov <span class="op">=</span> <span class="va">smc_data</span>,</span>
<span>  months_30_days <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  years <span class="op">=</span> <span class="va">years_analysis</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">smc_schedule</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="ensuring-alignment-of-model-inputs">Ensuring alignment of model inputs<a class="anchor" aria-label="anchor" href="#ensuring-alignment-of-model-inputs"></a>
</h3>
<p>As mentioned before, it is necessary that the climate and SMC inputs
begin on the same date - otherwise a given day will not have the climate
and SMC information actually corresponding to that day. To ensure that
this is the case, we have a helper function that checks this condition
and another that trims them accordingly. Furthermore, as we have a lag
on climate, we need the climate vectors to have data before the date
when SMC starts. The following code helps to ensure everything is
aligned.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">met_365</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_climate_to_end_date.html">impute_climate_to_end_date</a></span><span class="op">(</span><span class="va">met_365</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">smc_schedule</span><span class="op">$</span><span class="va">dates</span><span class="op">)</span><span class="op">)</span> <span class="co"># climate data only available until December 2023</span></span>
<span></span>
<span><span class="co"># Specify lag</span></span>
<span><span class="va">clim_smc_lag</span> <span class="op">&lt;-</span> <span class="fl">180</span></span>
<span></span>
<span><span class="co"># Validate continuity, span, and alignment</span></span>
<span><span class="co"># validate_smc_climate_alignment(smc_schedule, met_365, clim_smc_lag)</span></span>
<span></span>
<span><span class="co"># Trim &amp; align</span></span>
<span><span class="va">aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lag_and_trim_smc_climate.html">lag_and_trim_smc_climate</a></span><span class="op">(</span><span class="va">smc_schedule</span>, <span class="va">met_365</span>, <span class="va">clim_smc_lag</span><span class="op">)</span></span>
<span><span class="va">smc_schedule</span>    <span class="op">&lt;-</span> <span class="va">aligned</span><span class="op">$</span><span class="va">smc</span></span>
<span><span class="va">met_365</span> <span class="op">&lt;-</span> <span class="va">aligned</span><span class="op">$</span><span class="va">climate</span></span>
<span></span>
<span><span class="fu"><a href="../reference/validate_smc_climate_alignment.html">validate_smc_climate_alignment</a></span><span class="op">(</span><span class="va">smc_schedule</span>, <span class="va">met_365</span>, <span class="va">clim_smc_lag</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="simulating-from-the-malaria-model">Simulating from the Malaria Model<a class="anchor" aria-label="anchor" href="#simulating-from-the-malaria-model"></a>
</h2>
<p>One last model input is the population size of the region being
studied. In the case of Chad, there is much uncertainty about the true
population size so we will also include in the model a population
scaling factor. This means that the results are not so sensitivity to
the chosen population size value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">150000</span></span></code></pre></div>
<p>Now, the climate model is loaded using “load_model” which takes as an
input the name of the model. Here it is called “model_new_R_with_FOI”.
In principle, one could adjust the model or add new models which could
then be loaded and simulated from. The model itself is written in
‘odin’, a domain-specific language (DSL) created for facilitating the
writing of efficient state-space models. More information can be found
in the original paper by FitzJohn et al
(10.12688/wellcomeopenres.16466.2).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">malaria_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_model.html">load_model</a></span><span class="op">(</span><span class="st">"model_new_R_with_FOI"</span><span class="op">)</span>  <span class="co"># Load the deterministic climate model</span></span></code></pre></div>
<p>One last object to define before running the model itself. This input
is a named list where each name corresponds to a parameter within the
model and the values can be specified based on prior knowledge or by
fitting to some observed data. Many of the parameter values here come
from the paper by Ukawuba and Shaman where the model was fit to
district-level data in Rwanda.</p>
<p>Found below is a table with information about each parameter (taken
directly from Ukawuba), as well as the corresponding name in the paper
by Ukawuba, as the naming convention differs slightly for some
parameters (still need to define).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract rainfall and temperature data</span></span>
<span><span class="va">rain</span> <span class="op">&lt;-</span> <span class="va">met_365</span><span class="op">$</span><span class="va">anom</span>  <span class="co"># Standardized rolling mean of rainfall</span></span>
<span><span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">met_365</span><span class="op">$</span><span class="va">temp</span>  <span class="co"># Temperature data</span></span>
<span></span>
<span><span class="co"># Extract key SMC schedule information</span></span>
<span><span class="va">SMC</span> <span class="op">&lt;-</span> <span class="va">smc_schedule</span><span class="op">$</span><span class="va">SMC</span>  <span class="co"># Indicator for days when an SMC round started (1s and 0s)</span></span>
<span><span class="va">decay</span> <span class="op">&lt;-</span> <span class="va">smc_schedule</span><span class="op">$</span><span class="va">decay</span>  <span class="co"># Efficacy decay of SMC over time</span></span>
<span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="va">smc_schedule</span><span class="op">$</span><span class="va">cov</span>  <span class="co"># SMC coverage over time</span></span>
<span></span>
<span><span class="co"># Define parameter inputs for the malaria model simulation</span></span>
<span><span class="va">param_inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Rate and Demographic parameters</span></span>
<span>  mu_TS <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">30</span>, mu_IR <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span>, mu_RS <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">195</span>,</span>
<span>  mu_EI <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span>, delta_b <span class="op">=</span> <span class="fl">47</span><span class="op">/</span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span>, delta_d <span class="op">=</span> <span class="fl">47</span><span class="op">/</span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="fl">365</span><span class="op">)</span>,</span>
<span>  delta_a <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">5</span> <span class="op">*</span> <span class="fl">365</span><span class="op">)</span>, N <span class="op">=</span> <span class="va">N</span>, percAdult <span class="op">=</span> <span class="fl">0.81</span>,</span>
<span></span>
<span>  <span class="co"># Immunity and Reporting Parameters</span></span>
<span>  pi_s_1 <span class="op">=</span> <span class="fl">0.75</span>, c_s <span class="op">=</span> <span class="fl">0.12</span>,</span>
<span>  qR <span class="op">=</span> <span class="fl">0.24</span>,</span>
<span></span>
<span>  <span class="co"># Immunity and Reporting Parameters</span></span>
<span>  fT_C <span class="op">=</span> <span class="fl">0.28</span>,</span>
<span></span>
<span>  <span class="co"># Population Scaling factor</span></span>
<span>  s <span class="op">=</span> <span class="fl">9</span>,</span>
<span></span>
<span>  <span class="co"># Growth rates</span></span>
<span>  r_C_0 <span class="op">=</span> <span class="fl">1.000079</span>,</span>
<span>  r_A_0 <span class="op">=</span> <span class="fl">1.000108</span>,</span>
<span></span>
<span>  <span class="co"># Time-varying Inputs</span></span>
<span>  decay <span class="op">=</span> <span class="va">decay</span>,</span>
<span>  SMC <span class="op">=</span> <span class="va">SMC</span>,</span>
<span>  cov_SMC <span class="op">=</span> <span class="va">cov</span>,</span>
<span>  c_R_D <span class="op">=</span> <span class="va">rain</span>, temp <span class="op">=</span> <span class="va">temp</span>,</span>
<span></span>
<span>  <span class="co"># Climate Parameters</span></span>
<span>  b <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  R_opt <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  sigma_LT <span class="op">=</span> <span class="fl">4</span>, sigma_RT <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  k1 <span class="op">=</span> <span class="fl">1.5</span>, lag_R <span class="op">=</span> <span class="fl">30</span>, lag_T <span class="op">=</span> <span class="fl">15</span>,</span>
<span></span>
<span>  <span class="co"># Likelihood function parameters</span></span>
<span>  size_1 <span class="op">=</span> <span class="fl">15</span>,</span>
<span></span>
<span>  <span class="co"># SMC parameters</span></span>
<span>  eff_SMC <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span></span>
<span>  <span class="co"># Misc</span></span>
<span>  clim_SMC_lag <span class="op">=</span> <span class="va">clim_smc_lag</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Before doing inference, let’s first take a look at what the model
output looks like using the parameter values defined above. We first
simulate weekly malaria cases using the `data_sim’ function (this
function is used a lot behind the scenes throughout the fitting and
inference diagnostics process). Afterwards, we’ll plot the weekly
malaria cases given by the model from 2018 to the end of 2023. Note that
the default parameter values above are “selected” - it is worth changing
values and seeing how it changes the model outputs!</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the climate-malaria model simulation</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span></span>
<span>  <span class="va">malaria_model</span>, param_inputs <span class="op">=</span> <span class="va">param_inputs</span>, <span class="va">start_date</span>, <span class="va">end_date</span>,</span>
<span>  month <span class="op">=</span> <span class="cn">FALSE</span>, round <span class="op">=</span> <span class="cn">FALSE</span>, save <span class="op">=</span> <span class="cn">FALSE</span>, month_unequal_days <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_time_series.html">plot_time_series</a></span><span class="op">(</span>results <span class="op">=</span> <span class="va">results</span>, plot_title <span class="op">=</span> <span class="st">"Simulated Weekly Malaria Cases (2018 to 2023)"</span>,</span>
<span>                 select_incidence <span class="op">=</span> <span class="st">"&lt;5"</span>, incidence_y_label <span class="op">=</span> <span class="st">"Weekly Malaria Cases"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-inference">Model Inference<a class="anchor" aria-label="anchor" href="#model-inference"></a>
</h2>
<div class="section level3">
<h3 id="loading-observed-data">Loading observed data<a class="anchor" aria-label="anchor" href="#loading-observed-data"></a>
</h3>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">)</span></span>
<span><span class="va">obs_cases</span> <span class="op">&lt;-</span> <span class="va">obs_cases</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date_ymd</span> <span class="op">&gt;=</span> <span class="va">start_date</span><span class="op">)</span></span></code></pre></div>
<p>The observed data needs to have columns named in the same way shown
below. If the data is monthly, the `date_ymd’ column should correspond
to the first of the month in year, month, day format.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">obs_cases</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="weighting-observed-data">Weighting observed data<a class="anchor" aria-label="anchor" href="#weighting-observed-data"></a>
</h3>
<p>In our example, SMC was deployed each year except for 2019. This
means the inference procedure, which aims to maximize the posterior
probability globally, naturally gives more weight to years when SMC was
deployed (simply because there are more of them). The consequence is a
tendency to have worse model predictions for the year that SMC was
stopped. As we are ultimately interested in comparing scenarios where
SMC was and was not given, comparable performance across SMC status is
preferred to better global predictions.</p>
<p>Towards this goal, we take a simple approach and weight the non SMC
observations by how many times more SMC observations there are (e.g. if
across the dataset, SMC was given for 5 years and not given for 1 year,
then the weight for each observation in the years SMC was given would be
1, and the weight would be 5 for the year SMC was not given).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_cases</span><span class="op">$</span><span class="va">treatment</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">$</span><span class="va">date_ymd</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">2019</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">control_weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">$</span><span class="va">treatment</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_cases</span><span class="op">$</span><span class="va">obs_weight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">$</span><span class="va">date_ymd</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2019</span>, <span class="va">control_weight</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-model-parameters-to-estimate">Defining model parameters to estimate<a class="anchor" aria-label="anchor" href="#defining-model-parameters-to-estimate"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Listing the model parameters to be estimated</span></span>
<span><span class="va">params_to_estimate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>lag_R <span class="op">=</span> <span class="st">"lag_R"</span>, lag_T <span class="op">=</span> <span class="st">"lag_T"</span>,</span>
<span>                        sigma_LT <span class="op">=</span> <span class="st">"sigma_LT"</span>, sigma_RT <span class="op">=</span> <span class="st">"sigma_RT"</span>,</span>
<span>                        k1 <span class="op">=</span> <span class="st">"k1"</span>, size_1 <span class="op">=</span> <span class="st">"size_1"</span>,</span>
<span>                        eff_SMC <span class="op">=</span> <span class="st">"eff_SMC"</span>, s <span class="op">=</span> <span class="st">"s"</span>,</span>
<span>                        b <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-parameters-of-the-random-walk-metropolis-algorithm">Defining parameters of the Random-walk Metropolis Algorithm<a class="anchor" aria-label="anchor" href="#defining-parameters-of-the-random-walk-metropolis-algorithm"></a>
</h3>
<p>Inference is done in the Bayesian context, meaning we are targeting
the posterior distribution of the parameter set given the observed data,
which is proportional to the likelihood and prior probabilities. We
simulate from this posterior distribution using a popular Markov chain
Monte Carlo algorithm called ‘Random Walk Metropolis’. This is
implemented in the ‘mcstate’ package - more information can be found in
the original paper outlining the package (Fitz et al 2021).</p>
<p>Random-Walk Metropolis has different parameters that must be
specified prior to running the algorithm. To start, we need to decide
the number of steps to run the algorithm for. Additionally, we must
decide how many chains to run. One also needs to select where these
chains start. Furthermore, we have to define the covariance matrix of
the proposal distribution (here the proposal distribution is a
multivariate normal). This choice of a covariance matrix greatly impacts
the efficiency of the algorithm, especially when the parameters being
estimated have a complex dependency structure. Therefore, it’s important
to choose one carefully. Luckily, mcstate has build in functionality for
an “adaptive” proposal which learns the optimal proposal distribution
during the MCMC procedure (Spencer SEF 2021). More details can be found
here - <a href="https://mrc-ide.github.io/mcstate/reference/adaptive_proposal_control.html" class="external-link uri">https://mrc-ide.github.io/mcstate/reference/adaptive_proposal_control.html</a>.</p>
<p>In our case, we do inference in three stages. First, we start with a
relatively uninformed proposal distribution with a high level of
adaptation. Afterwards, we use this first stage to inform a second stage
where we update the proposal distribution and the starting values of the
chain. This second stage has less strong adaptation and the idea is to
continue until some sort of “convergence” is reached. Lastly, the
algorithm is run with no adaptation so that the algorithm represents
valid draws from the posterior distribution.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_mcmc_params.html">create_mcmc_params</a></span><span class="op">(</span>stage <span class="op">=</span> <span class="st">"stage1"</span><span class="op">)</span></span>
<span><span class="va">adaptive_params_1</span> <span class="op">&lt;-</span> <span class="va">params_default</span><span class="op">$</span><span class="va">adaptive_params</span></span>
<span><span class="va">control_params_1</span> <span class="op">&lt;-</span> <span class="va">params_default</span><span class="op">$</span><span class="va">control_params</span></span>
<span><span class="va">control_params_1</span><span class="op">$</span><span class="va">n_steps</span> <span class="op">=</span> <span class="fl">5000</span></span>
<span></span>
<span><span class="co"># Defining starting values for chains</span></span>
<span><span class="va">start_values_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_start_values.html">create_start_values</a></span><span class="op">(</span><span class="va">params_to_estimate</span>, <span class="va">control_params_1</span>,</span>
<span>                                      model <span class="op">=</span> <span class="va">malaria_model</span>, param_inputs <span class="op">=</span> <span class="va">param_inputs</span>,</span>
<span>                                      random <span class="op">=</span> <span class="cn">TRUE</span>, seed <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co"># Proposal matrix</span></span>
<span><span class="va">proposal_matrix_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_proposal_matrix.html">create_proposal_matrix</a></span><span class="op">(</span>params_to_estimate <span class="op">=</span> <span class="va">params_to_estimate</span>,</span>
<span>                                            model <span class="op">=</span> <span class="va">malaria_model</span>, param_inputs <span class="op">=</span> <span class="va">param_inputs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">proposal_matrix_1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-aspects-of-the-inference-procedure-not-related-to-mcmc">Defining aspects of the inference procedure not related to MCMC<a class="anchor" aria-label="anchor" href="#defining-aspects-of-the-inference-procedure-not-related-to-mcmc"></a>
</h3>
<p>Here we choose if we are using monthly or weekly data, which age
groups we are fitting to, and whether or not we should account for
population growth (this is currently being included as part of the
fitting procedure and not within the model itself.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inf_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_obs_config.html">make_obs_config</a></span><span class="op">(</span></span>
<span>  use_monthly <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  age_group <span class="op">=</span> <span class="st">"u5"</span>,</span>
<span>  include_pop_growth <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Small wrapper around inf_run() + diagnostics + saving</span></span>
<span><span class="va">run_stage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">proposal_matrix</span>, <span class="va">start_values</span>, <span class="va">control_params</span>,</span>
<span>                      <span class="va">adaptive_params</span>, <span class="va">out_dir</span>, <span class="va">out_file</span>, <span class="va">rerun_n</span> <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                      <span class="va">rerun_random</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">seed</span> <span class="op">=</span> <span class="fl">24</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Infer with all the shared args baked in</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/inf_run.html">inf_run</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">malaria_model</span>, param_inputs <span class="op">=</span> <span class="va">param_inputs</span>,</span>
<span>                     control_params <span class="op">=</span> <span class="va">control_params</span>,</span>
<span>                     params_to_estimate <span class="op">=</span> <span class="va">params_to_estimate</span>,</span>
<span>                     proposal_matrix <span class="op">=</span> <span class="va">proposal_matrix</span>,</span>
<span>                     adaptive_params <span class="op">=</span> <span class="va">adaptive_params</span>,</span>
<span>                     start_values <span class="op">=</span> <span class="va">start_values</span>,</span>
<span>                     noise <span class="op">=</span> <span class="cn">FALSE</span>, seed <span class="op">=</span> <span class="va">seed</span>,</span>
<span>                     month_unequal_days <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="va">end_date</span><span class="op">)</span>,</span>
<span>                     synthetic <span class="op">=</span> <span class="cn">FALSE</span>, incidence_df <span class="op">=</span> <span class="va">obs_cases</span>,</span>
<span>                     save_trajectories <span class="op">=</span> <span class="cn">FALSE</span>, rerun_n <span class="op">=</span> <span class="va">rerun_n</span>,</span>
<span>                     rerun_random <span class="op">=</span> <span class="va">rerun_random</span>, param_priors <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     n_years_warmup <span class="op">=</span> <span class="fl">3</span>, obs_config <span class="op">=</span> <span class="va">inf_config</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Save to disk</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">results</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="va">out_file</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return the results object</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-inference">Running Inference<a class="anchor" aria-label="anchor" href="#running-inference"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_results_out_dir</span> <span class="op">=</span> <span class="st">"C:/Users/putnni/Documents/git-hub-repositories/vignette-storage/malclimsim/mcmc-results/"</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_stage_1</span> <span class="op">&lt;-</span> <span class="fu">run_stage</span><span class="op">(</span><span class="va">proposal_matrix_1</span>, <span class="va">start_values_1</span>, </span>
<span>          control_params <span class="op">=</span> <span class="va">control_params_1</span>, </span>
<span>          adaptive_params <span class="op">=</span> <span class="va">adaptive_params_1</span>,</span>
<span>          out_dir <span class="op">=</span> <span class="va">mcmc_results_out_dir</span>,</span>
<span>          out_file <span class="op">=</span> <span class="st">"mcmc_results_stage_1.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_stage_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mcmc_results_out_dir</span>, <span class="st">"mcmc_results_stage_1.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">inf_params_stage_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_inf_stage.html">update_inf_stage</a></span><span class="op">(</span>results_obj <span class="op">=</span> <span class="va">mcmc_stage_1</span>,</span>
<span>   proposal_matrix <span class="op">=</span> <span class="va">proposal_matrix_1</span>,</span>
<span>   param_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">proposal_matrix_1</span><span class="op">)</span>,</span>
<span>   S_prev <span class="op">=</span> <span class="fl">3000</span>, draw_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">start_values_1</span><span class="op">)</span>,</span>
<span>   shrink <span class="op">=</span> <span class="fl">0.95</span>, stage <span class="op">=</span> <span class="st">"stage2"</span>, n_steps <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>          </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">mcmc_stage_1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mcmc_stage_2</span> <span class="op">&lt;-</span> <span class="fu">run_stage</span><span class="op">(</span>proposal_matrix <span class="op">=</span> <span class="va">inf_params_stage_2</span><span class="op">$</span><span class="va">proposal_matrix</span>, </span>
<span>                          start_values <span class="op">=</span> <span class="va">inf_params_stage_2</span><span class="op">$</span><span class="va">start_values</span>, </span>
<span>                          control_params <span class="op">=</span> <span class="va">inf_params_stage_2</span><span class="op">$</span><span class="va">control_params</span>, </span>
<span>                          adaptive_params <span class="op">=</span> <span class="va">inf_params_stage_2</span><span class="op">$</span><span class="va">adaptive_params</span>,</span>
<span>                          out_dir <span class="op">=</span> <span class="va">mcmc_results_out_dir</span>,</span>
<span>                          out_file <span class="op">=</span> <span class="st">"mcmc_results_stage_2.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_stage_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mcmc_results_out_dir</span>, <span class="st">"mcmc_results_stage_2.rds"</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">inf_params_stage_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_inf_stage.html">update_inf_stage</a></span><span class="op">(</span>results_obj <span class="op">=</span> <span class="va">mcmc_stage_2</span>,</span>
<span>   proposal_matrix <span class="op">=</span> <span class="va">inf_params_stage_2</span><span class="op">$</span><span class="va">proposal_matrix</span>,</span>
<span>   param_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">proposal_matrix_1</span><span class="op">)</span>,</span>
<span>   S_prev <span class="op">=</span> <span class="fl">3000</span>, draw_n <span class="op">=</span> <span class="fl">3</span>,</span>
<span>   shrink <span class="op">=</span> <span class="fl">0.8</span>, stage <span class="op">=</span> <span class="st">"noadapt"</span>, n_steps <span class="op">=</span> <span class="fl">20000</span><span class="op">)</span></span>
<span>          </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">mcmc_stage_2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mcmc_stage_3</span> <span class="op">&lt;-</span> <span class="fu">run_stage</span><span class="op">(</span>proposal_matrix <span class="op">=</span> <span class="va">inf_params_stage_3</span><span class="op">$</span><span class="va">proposal_matrix</span>, </span>
<span>                          start_values <span class="op">=</span> <span class="va">inf_params_stage_3</span><span class="op">$</span><span class="va">start_values</span>, </span>
<span>                          control_params <span class="op">=</span> <span class="va">inf_params_stage_3</span><span class="op">$</span><span class="va">control_params</span>, </span>
<span>                          adaptive_params <span class="op">=</span> <span class="va">inf_params_stage_3</span><span class="op">$</span><span class="va">adaptive_params</span>,</span>
<span>                          out_dir <span class="op">=</span> <span class="va">mcmc_results_out_dir</span>,</span>
<span>                          out_file <span class="op">=</span> <span class="st">"mcmc_results_stage_3.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="inference-diagnostics">Inference Diagnostics<a class="anchor" aria-label="anchor" href="#inference-diagnostics"></a>
</h2>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_stage_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">mcmc_results_out_dir</span>, <span class="st">"mcmc_results_stage_3.rds"</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<div class="section level3">
<h3 id="examining-trace-plots">Examining trace plots<a class="anchor" aria-label="anchor" href="#examining-trace-plots"></a>
</h3>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_trace</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MCMC_diag.html">MCMC_diag</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span>, params <span class="op">=</span> <span class="st">"trace"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="gelman-rubin-test">Gelman-rubin test<a class="anchor" aria-label="anchor" href="#gelman-rubin-test"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/MCMC_diag.html">MCMC_diag</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span>, params <span class="op">=</span> <span class="st">"gelman"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="correlation-between-parameters">Correlation between parameters<a class="anchor" aria-label="anchor" href="#correlation-between-parameters"></a>
</h3>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_corr.html">plot_corr</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="marginal-posterior-distributions">Marginal posterior distributions<a class="anchor" aria-label="anchor" href="#marginal-posterior-distributions"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Posterior plot</span></span>
<span><span class="va">post_plot_fig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/post_plot.html">post_plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span><span class="op">)</span>, <span class="va">params_to_estimate</span>, dim_plot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  show_prior <span class="op">=</span> <span class="cn">TRUE</span>, run_labels <span class="op">=</span> <span class="st">"Moissala"</span>,</span>
<span>  title <span class="op">=</span> <span class="st">"Posteriors"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">post_plot_fig</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="assessing-model-fit">Assessing Model Fit<a class="anchor" aria-label="anchor" href="#assessing-model-fit"></a>
</h2>
<div class="section level3">
<h3 id="sampling-from-the-posterior-distribution">Sampling from the posterior distribution<a class="anchor" aria-label="anchor" href="#sampling-from-the-posterior-distribution"></a>
</h3>
<p>We will now plot the values predicted by the model to the observed
values to assess how well our model is recreating the data (aka a
posterior predictive check). To do this, we first sample a certain
number of parameter sets from the posterior distribution.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample posterior draws from MCMC</span></span>
<span><span class="va">n_samples</span> <span class="op">&lt;-</span> <span class="fl">400</span></span>
<span><span class="va">param_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_mcmc_steps.html">sample_mcmc_steps</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span><span class="op">$</span><span class="va">coda_pars</span>, <span class="va">n_samples</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-population-growth-input">Defining population growth input<a class="anchor" aria-label="anchor" href="#defining-population-growth-input"></a>
</h3>
<p>As population growth was used as part of the inference procedure, we
also need to include population growth when comparing the model to the
observed data.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create covariate matrix (population growth)</span></span>
<span><span class="va">r_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_population_scaling.html">get_population_scaling</a></span><span class="op">(</span></span>
<span>  n             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">obs_cases</span><span class="op">)</span>,</span>
<span>  month         <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  growth_rate_C <span class="op">=</span> <span class="va">param_inputs</span><span class="op">$</span><span class="va">r_C_0</span>,</span>
<span>  growth_rate_A <span class="op">=</span> <span class="va">param_inputs</span><span class="op">$</span><span class="va">r_A_0</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pop_growth_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  date_ymd <span class="op">=</span> <span class="va">obs_cases</span><span class="op">$</span><span class="va">date_ymd</span>,</span>
<span>  r_C <span class="op">=</span> <span class="va">r_df</span><span class="op">$</span><span class="va">r_C</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define transformation for SMC-adjusted incidence</span></span>
<span><span class="va">mu_transform_C</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">inc_df</span>, <span class="va">param_inputs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inc_df</span><span class="op">$</span><span class="va">inc_C</span> <span class="op">*</span> <span class="va">inc_df</span><span class="op">$</span><span class="va">r_C</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="simulating-cases-using-the-best-parameters">Simulating cases using the best parameters<a class="anchor" aria-label="anchor" href="#simulating-cases-using-the-best-parameters"></a>
</h3>
<p>We start by extracting which parameter sets maximized the posterior
distribution and simulate the weekly number of cases using these
values</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract MAP (max posterior) parameter set</span></span>
<span><span class="va">max_posterior_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/extract_max_posterior_params.html">extract_max_posterior_params</a></span><span class="op">(</span><span class="va">mcmc_stage_3</span><span class="op">)</span></span>
<span><span class="va">param_inputs_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_param_list.html">update_param_list</a></span><span class="op">(</span><span class="va">param_inputs</span>, <span class="va">max_posterior_params</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Simulate cases using the best parameter set (deterministic, no noise)</span></span>
<span><span class="va">sim_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span></span>
<span>  model         <span class="op">=</span> <span class="va">malaria_model</span>,</span>
<span>  param_inputs  <span class="op">=</span> <span class="va">param_inputs_best</span>,</span>
<span>  start_date    <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>  end_date      <span class="op">=</span> <span class="va">end_date</span>,</span>
<span>  noise         <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  mu_transform_C <span class="op">=</span> <span class="va">mu_transform_C</span>,</span>
<span>  mu_transform_A <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  covariate_matrix <span class="op">=</span> <span class="va">pop_growth_df</span>,</span>
<span>  month <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  save <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_best_long</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">sim_best</span>, <span class="op">-</span><span class="va">date_ymd</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="constructing-the-uncertainty-prediction-interval">Constructing the uncertainty (prediction) interval<a class="anchor" aria-label="anchor" href="#constructing-the-uncertainty-prediction-interval"></a>
</h3>
<p>Now, we simulate using the different parameter sets sampled from the
posterior distribution. We also add observation noise coming from a
negative binomial distribution. This provides an interval that gives the
range of weekly malaria cases we’d be likely to observe.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate cases using different parameter sets coming from MCMC run</span></span>
<span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_simulations_from_samples.html">run_simulations_from_samples</a></span><span class="op">(</span></span>
<span>  model         <span class="op">=</span> <span class="va">malaria_model</span>,</span>
<span>  param_inputs  <span class="op">=</span> <span class="va">param_inputs_best</span>,</span>
<span>  param_samples <span class="op">=</span> <span class="va">param_samples</span>,</span>
<span>  start_date    <span class="op">=</span> <span class="va">start_date</span>,</span>
<span>  end_date      <span class="op">=</span> <span class="va">end_date</span>,</span>
<span>  prewarm_years <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  mu_transform_C <span class="op">=</span> <span class="va">mu_transform_C</span>,</span>
<span>  mu_transform_A <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  covariate_matrix <span class="op">=</span> <span class="va">pop_growth_df</span>,</span>
<span>  noise         <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  month         <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The simulations are then summarized and we plot the resulting
posterior predictive check.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarize the simulations</span></span>
<span><span class="va">ci_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize_simulation_ci.html">summarize_simulation_ci</a></span><span class="op">(</span><span class="va">simulations</span>, variables <span class="op">=</span> <span class="st">"inc_C_transformed"</span>, ci_level <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Format the simulated and observed data for plotting</span></span>
<span><span class="va">ppc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_ppc_data.html">prepare_ppc_data</a></span><span class="op">(</span></span>
<span>  ci_data <span class="op">=</span> <span class="va">ci_data</span>,</span>
<span>  best_df <span class="op">=</span> <span class="va">sim_best_long</span>,</span>
<span>  obs_df  <span class="op">=</span> <span class="va">obs_cases</span>,</span>
<span>  sim_var <span class="op">=</span> <span class="st">"inc_C_transformed"</span>,</span>
<span>  obs_var <span class="op">=</span> <span class="st">"inc_C"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the posterior predictive check</span></span>
<span><span class="va">ppc_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_ppc.html">plot_ppc</a></span><span class="op">(</span></span>
<span>  ppc_data <span class="op">=</span> <span class="va">ppc_data</span>,</span>
<span>  ci_data <span class="op">=</span> <span class="va">ci_data</span>,</span>
<span>  title       <span class="op">=</span> <span class="st">"Posterior Predictive Check"</span>,</span>
<span>  xlab        <span class="op">=</span> <span class="st">""</span>,</span>
<span>  ylab        <span class="op">=</span> <span class="st">"Weekly Number of Cases"</span>,</span>
<span>  show_obs    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  show_best   <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  show_ribbon <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ppc_plot</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Nicholas Putney.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
